generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Users table (UPDATED: role is now optional, no default)
model User {
  id                String    @id @default(uuid())
  email             String    @unique
  passwordHash      String    @map("password_hash")
  fullname         String    @map("full_name")
  role              Role?     // UPDATED: Nullable, no default
  profileImageUrl   String?   @map("profile_image_url")
  isEmailVerified   Boolean   @default(false) @map("is_email_verified")
  isActive          Boolean   @default(true) @map("is_active")
  
  // Onboarding fields
  onboardingCompleted Boolean  @default(false) @map("onboarding_completed")
  purpose             String?  // 'learn' or 'find_opportunity'
  userType            String?  @map("user_type") // 'student', 'learner', 'teacher', 'other_profession'
  classLevel          String?  @map("class_level") // '6', '7', '8', '9', '10'
  skill               String?  // 'digital_marketing', 'video_editing'
  
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  // Relations
  courses           Course[]
  enrollments       Enrollment[]
  payments          Payment[]
  reviews           Review[]
  videoProgress     VideoProgress[]
  passwordResetTokens PasswordResetToken[]
  subscription      Subscription? // NEW relation

  @@index([email])
  @@index([role])
  @@map("users")
}

enum Role {
  ADMIN
  TEACHER
  STUDENT
  USER
  LEARNER
}

// Password Reset Tokens
model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  token     String   @unique
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("password_reset_tokens")
}

// Courses
model Course {
  id              String    @id @default(uuid())
  title           String
  slug            String    @unique
  description     String?   @db.Text
  thumbnailUrl    String?   @map("thumbnail_url")
  teacherId       String    @map("teacher_id")
  instructorName  String?   @map("instructor_name") // NEW: Display instructor name
  category        String?
  level           Level?
  durationHours   Float?    @map("duration_hours")
  price           Float     @default(0)
  discountPrice   Float?    @map("discount_price")
  isPublished     Boolean   @default(false) @map("is_published")
  enrollmentCount Int       @default(0) @map("enrollment_count")
  rating          Float     @default(0)
  language        String    @default("English") // NEW
  videoPreviewUrl String?   @map("video_preview_url") // NEW
  skills          String[]  @default([]) // NEW: Array of skills
  totalLessons    Int       @default(0) @map("total_lessons") // NEW
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  teacher     User            @relation(fields: [teacherId], references: [id])
  sections    CourseSection[]
  enrollments Enrollment[]
  payments    Payment[]
  reviews     Review[]
  notes       CourseNote[]

  @@index([teacherId])
  @@index([slug])
  @@index([isPublished])
  @@map("courses")
}

enum Level {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

// Course Sections
model CourseSection {
  id          String   @id @default(uuid())
  courseId    String   @map("course_id")
  title       String
  description String?  @db.Text
  orderIndex  Int      @map("order_index")
  createdAt   DateTime @default(now()) @map("created_at")

  course Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  videos Video[]
  notes  CourseNote[]

  @@index([courseId])
  @@map("course_sections")
}

// Videos
model Video {
  id               String   @id @default(uuid())
  sectionId        String   @map("section_id")
  title            String
  description      String?  @db.Text
  videoUrl         String   @map("video_url")
  thumbnailUrl     String?  @map("thumbnail_url")
  durationSeconds  Int?     @map("duration_seconds")
  orderIndex       Int      @map("order_index")
  isPreview        Boolean  @default(false) @map("is_preview")
  processingStatus String   @default("pending") @map("processing_status")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  section       CourseSection   @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  videoProgress VideoProgress[]

  @@index([sectionId])
  @@map("videos")
}

// Course Notes
model CourseNote {
  id         String   @id @default(uuid())
  courseId   String   @map("course_id")
  sectionId  String?  @map("section_id")
  title      String
  content    String   @db.Text
  fileUrl    String?  @map("file_url")
  orderIndex Int?     @map("order_index")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  course  Course         @relation(fields: [courseId], references: [id], onDelete: Cascade)
  section CourseSection? @relation(fields: [sectionId], references: [id], onDelete: SetNull)

  @@index([courseId])
  @@map("course_notes")
}

// Enrollments
model Enrollment {
  id                 String    @id @default(uuid())
  userId             String    @map("user_id")
  courseId           String    @map("course_id")
  enrolledAt         DateTime  @default(now()) @map("enrolled_at")
  completedAt        DateTime? @map("completed_at")
  progressPercentage Float     @default(0) @map("progress_percentage")
  lastAccessedAt     DateTime? @map("last_accessed_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@map("enrollments")
}

// Video Progress
model VideoProgress {
  id             String   @id @default(uuid())
  userId         String   @map("user_id")
  videoId        String   @map("video_id")
  watchedSeconds Int      @default(0) @map("watched_seconds")
  completed      Boolean  @default(false)
  lastWatchedAt  DateTime @default(now()) @map("last_watched_at")

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  video Video @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([userId, videoId])
  @@index([userId])
  @@map("video_progress")
}

// Reviews
model Review {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  courseId  String   @map("course_id")
  rating    Int
  comment   String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([courseId])
  @@map("reviews")
}

// NEW: Plan model (optional; can be hardcoded in code if you don't need admin-editable plans)
model Plan {
  id           String       @id @default(uuid())
  name         String       @unique // e.g., 'Free Trial', 'Basic', 'Premium', 'Pro'
  description  String?
  monthlyPrice Float        @map("monthly_price")
  annualPrice  Float        @map("annual_price")
  features     String[]     // Array of feature strings
  limitations  String[]     // Array of limitation strings
  isTrial      Boolean      @default(false)
  trialDays    Int?         // e.g., 7 for free trial
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  subscriptions Subscription[]

  @@map("plans")
}

// NEW: Subscription model
model Subscription {
  id             String            @id @default(uuid())
  userId         String            @unique @map("user_id") // One subscription per user
  planId         String            @map("plan_id")
  billingPeriod  BillingPeriod     @map("billing_period")
  startDate      DateTime          @default(now()) @map("start_date")
  endDate        DateTime?         @map("end_date") // For trials; for paid, use nextBillingDate
  nextBillingDate DateTime?        @map("next_billing_date") // For recurring
  status         SubscriptionStatus @default(ACTIVE)
  createdAt      DateTime          @default(now()) @map("created_at")
  updatedAt      DateTime          @updatedAt @map("updated_at")

  user          User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan          Plan                   @relation(fields: [planId], references: [id])
  notifications SubscriptionNotification[]
  payments      Payment[]              @relation("SubscriptionToPayments") // Explicit relation name

  @@index([userId])
  @@index([planId])
  @@map("subscriptions")
}

enum BillingPeriod {
  MONTHLY
  ANNUAL
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  PENDING
}

// NEW: SubscriptionNotification model (tracks sent notifications for trials)
model SubscriptionNotification {
  id              String       @id @default(uuid())
  subscriptionId  String       @map("subscription_id")
  type            String       // e.g., 'reminder', 'final_warning'
  sentAt          DateTime     @map("sent_at")
  createdAt       DateTime     @default(now()) @map("created_at")

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@map("subscription_notifications")
}

// UPDATED: Payment model (make courseId optional, add subscriptionId for subscription payments)
model Payment {
  id                     String    @id @default(uuid())
  userId                 String    @map("user_id")
  courseId               String?   @map("course_id") // UPDATED: Optional now
  subscriptionId         String?   @map("subscription_id") // NEW: For subscription payments
  amount                 Float
  currency               String    @default("USD")
  paymentMethod          String?   @map("payment_method")
  stripePaymentIntentId  String?   @unique @map("stripe_payment_intent_id")
  status                 PaymentStatus
  paidAt                 DateTime? @map("paid_at")
  createdAt              DateTime  @default(now()) @map("created_at")

  user         User         @relation(fields: [userId], references: [id])
  course       Course?      @relation(fields: [courseId], references: [id], onDelete: SetNull) // UPDATED: Optional relation with explicit onDelete
  subscription Subscription? @relation("SubscriptionToPayments", fields: [subscriptionId], references: [id], onDelete: SetNull) // NEW relation with explicit name and onDelete

  @@index([userId])
  @@index([stripePaymentIntentId])
  @@index([subscriptionId]) // NEW index
  @@map("payments")
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}